<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKIM AOTEAROA</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; overflow: hidden; background: #0b0d0f; }
        #map { height: 100vh; width: 100vw; z-index: 1; background: #0b0d0f; }

        /* --- LOADING SPINNER --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0b0d0f; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease-out, visibility 0.8s;
        }
        .spinner {
            width: 50px; height: 50px; border: 3px solid rgba(0, 242, 255, 0.2);
            border-top: 3px solid #00f2ff; border-radius: 50%;
            animation: spin 1s linear infinite, glow 2s ease-in-out infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px #00f2ff; } 50% { box-shadow: 0 0 20px #00f2ff; } }
        #loader p { color: #00f2ff; margin-top: 15px; letter-spacing: 4px; font-size: 12px; font-weight: bold; }

        /* --- CUSTOM INVERTING CURSOR --- */
        @media (hover: hover) and (pointer: fine) {
            * { cursor: none !important; }
            #cursor {
                width: 1rem; height: 1rem; background-color: white; border-radius: 50%; 
                position: fixed; pointer-events: none; z-index: 99999;
                transform: translate(-50%, -50%); mix-blend-mode: difference; 
                box-shadow: 0 0 10px #00f2ff; transition: transform 0.15s ease-out; 
            }
            #cursor.hovering { transform: translate(-50%, -50%) scale(4); opacity: 0.4; }
        }

        /* --- UI ELEMENTS --- */
        #title-card {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(0,0,0,0.85); color: white;
            padding: 8px 25px; border-radius: 50px; border: 1px solid #00f2ff;
            letter-spacing: 2px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); pointer-events: none;
        }
        #title-card h1 { margin: 0; font-size: 22px; pointer-events: auto; }

        #controls-container {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            display: flex; flex-direction: column; gap: 8px;
        }
        #region-select, #search-bar { 
            background: rgba(0,0,0,0.8); color: white; border: 1px solid #00f2ff; 
            padding: 12px; border-radius: 8px; font-weight: bold; outline: none; width: 220px;
        }

        #locate-btn { position: absolute; bottom: 30px; left: 20px; z-index: 1000; background: #00f2ff; color: black; border: none; padding: 12px 18px; border-radius: 8px; font-weight: bold; }
        #add-link { position: absolute; bottom: 30px; right: 20px; z-index: 1000; background: rgba(255,255,255,0.9); color: black; padding: 12px 18px; border-radius: 8px; text-decoration: none; font-weight: bold; }

        /* --- INFO PANEL & TIDE LIGHTS --- */
        #info-panel {
            position: fixed; top: 0; right: -400px; width: 340px; height: 100%;
            background: white; z-index: 2000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -10px 0 30px rgba(0,0,0,0.3); padding: 25px;
            display: flex; flex-direction: column; overflow-y: auto; color: #333;
        }
        #info-panel.active { right: 0; }
        .close-btn { cursor: pointer; float: right; font-size: 30px; line-height: 1; }

        .tide-rating-container { display: flex; justify-content: space-between; margin-top: 15px; gap: 8px; }
        .tide-light { 
            flex: 1; padding: 12px 4px; border-radius: 8px; text-align: center; 
            font-size: 11px; font-weight: 900; color: white; text-transform: uppercase;
            background-color: #ddd; transition: all 0.3s ease;
        }
        /* Tide Colors */
        .light-1 { background-color: #ff4444 !important; box-shadow: 0 0 10px rgba(255,68,68,0.4); } /* NO GO / BAD */
        .light-2 { background-color: #ffbb33 !important; box-shadow: 0 0 10px rgba(255,187,51,0.4); } /* AVG / OK */
        .light-3 { background-color: #00c851 !important; box-shadow: 0 0 10px rgba(0,200,81,0.4); } /* GOOD */
        .tide-label { color: #888; font-size: 9px; margin-bottom: 4px; display: block; text-align: center; font-weight: bold; }

        /* Map styling */
        .region-mask { fill: #000; fill-opacity: 0.6; stroke: none; pointer-events: none !important; }
        .region-highlight { filter: drop-shadow(0 0 15px #00f2ff); pointer-events: none !important; }
        .city-label { background: none; border: none; color: rgba(255,255,255,0.7); font-size: 10px; font-weight: bold; text-transform: uppercase; text-shadow: 0 0 5px black; }
        
        .hue-blue { filter: hue-rotate(140deg) brightness(1.2); }
        .hue-green { filter: hue-rotate(260deg) brightness(1.2); }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p>LOADING AOTEAROA</p>
    </div>

    <div id="cursor"></div>

    <div id="controls-container">
        <select id="region-select" onchange="handleRegionChange(this.value)">
            <option value="nz">ALL NEW ZEALAND</option>
            <option value="Northland">NORTHLAND</option>
            <option value="Auckland">AUCKLAND</option>
            <option value="Waikato">WAIKATO</option>
            <option value="Bay of Plenty">BAY OF PLENTY</option>
            <option value="Taranaki">TARANAKI</option>
            <option value="Gisborne">GISBORNE</option>
            <option value="Hawke's Bay">HAWKE'S BAY</option>
            <option value="Manawatu-Whanganui">MANAWATÅª-WHANGANUI</option>
            <option value="Wellington">WELLINGTON</option>
            <option value="Canterbury">CANTERBURY</option>
            <option value="Otago">OTAGO</option>
            <option value="Southland">SOUTHLAND</option>
        </select>
        <input type="text" id="search-bar" placeholder="ðŸ” SEARCH BEACH..." oninput="searchSpots(this.value)">
    </div>

    <div id="title-card"><h1>SKIM AOTEAROA</h1></div>
    <button id="locate-btn" onclick="locateUser()">ðŸŽ¯ FIND MY BEACH</button>
    <a href="add.html" id="add-link">âž• ADD SPOT</a>

    <div id="info-panel">
        <div><span class="close-btn" onclick="closePanel()">&times;</span></div>
        <h2 id="spot-name" style="margin-top:10px;">Spot Name</h2>
        <p style="font-size: 11px; font-weight: bold; margin: 20px 0 5px 0; color: #888; letter-spacing: 1px;">SKIMMABILITY BY TIDE:</p>
        <div class="tide-rating-container">
            <div><span class="tide-label">LOW</span><div id="light-low" class="tide-light">-</div></div>
            <div><span class="tide-label">MID</span><div id="light-mid" class="tide-light">-</div></div>
            <div><span class="tide-label">HIGH</span><div id="light-high" class="tide-light">-</div></div>
        </div>
        <p id="spot-desc" style="line-height: 1.6; color: #444; font-size: 14px; margin-top: 25px;"></p>
        <img id="spot-img" style="width:100%; border-radius: 12px; margin-top: 20px;" src="">
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
    // --- 1. INITIALIZE MAP ---
    const map = L.map('map', { 
        zoomControl: false, 
        minZoom: 4, 
        worldCopyJump: true // Crucial East Coast fix
    }).setView([-40.9, 174.88], 6);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);

    let boundaryLayer = L.layerGroup().addTo(map);
    let activeOverlay = null;
    let allMarkers = [];

    // --- 2. SMOOTH CURSOR ---
    (function () {
        const cursor = document.getElementById('cursor');
        let mouseX = window.innerWidth / 2, mouseY = window.innerHeight / 2;
        let cursorX = mouseX, cursorY = mouseY;
        document.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; }, { passive: true });
        function animate() {
            cursorX += (mouseX - cursorX) * 0.08;
            cursorY += (mouseY - cursorY) * 0.08;
            cursor.style.left = cursorX + 'px';
            cursor.style.top = cursorY + 'px';
            requestAnimationFrame(animate);
        }
        animate();
        const targets = 'a, button, input, select, .leaflet-marker-icon, .city-label, .close-btn';
        document.addEventListener('mouseover', e => { if (e.target.closest(targets)) cursor.classList.add('hovering'); });
        document.addEventListener('mouseout', e => { if (e.target.closest(targets)) cursor.classList.remove('hovering'); });
    })();

    // --- 3. DATA LOADING ---
    const sb = supabase.createClient('https://igntxtfvlcewvqazkwyf.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnbnR4dGZ2bGNld3ZxYXprd3lmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxOTM0ODMsImV4cCI6MjA4NTc2OTQ4M30.mxlSU_vXTzcgJO-WtB-qp9m9lKlC_PuYq2c__9m1UR8');

    async function loadGeoData() {
        try {
            const bResp = await fetch('cdem-group-boundaries.json');
            if (bResp.ok) {
                const bData = await bResp.json();
                L.geoJSON(bData, {
                    onEachFeature: (f, l) => boundaryLayer.addLayer(l),
                    style: { opacity: 0, fillOpacity: 0, interactive: false }
                });
            }
            const cResp = await fetch('city.json');
            if (cResp.ok) {
                const cData = await cResp.json();
                L.geoJSON(cData, {
                    pointToLayer: (f, latlng) => L.marker(latlng, {
                        icon: L.divIcon({ className: 'city-label', html: `<span>${f.properties.NAME || ""}</span>`, iconSize: [120, 20] }),
                        interactive: false
                    })
                }).addTo(map);
            }
        } catch (e) { console.error(e); }
    }

    async function loadSpots() {
        const { data } = await sb.from('spots').select('*').eq('is_approved', true);
        if (data) {
            data.forEach(spot => {
                const marker = L.marker([spot.lat, spot.lng]).addTo(map);
                if (marker._icon) marker._icon.classList.add(spot.spot_type === 'wave' ? 'hue-blue' : 'hue-green');
                
                marker.on('click', () => {
                    document.getElementById('spot-name').innerText = spot.name;
                    document.getElementById('spot-desc').innerText = spot.description || "";
                    document.getElementById('spot-img').src = spot.image_url || "";
                    
                    // --- THE TIDE LIGHT FIX ---
                    // Re-mapping to 'rating_low' etc. to match your working database
                    updateLight('light-low', spot.rating_low);
                    updateLight('light-mid', spot.rating_mid);
                    updateLight('light-high', spot.rating_high);
                    
                    document.getElementById('info-panel').classList.add('active');
                });
                spot.marker = marker;
                allMarkers.push(spot);
            });
        }
    }

    function updateLight(id, rating) {
        const el = document.getElementById(id);
        el.className = 'tide-light'; // Reset
        if (!rating) {
            el.innerText = '-';
            return;
        }
        el.classList.add('light-' + rating);
        el.innerText = rating == 3 ? 'GOOD' : (rating == 2 ? 'OK' : 'BAD');
    }

    // --- 4. REGION / SEARCH LOGIC ---
    function handleRegionChange(regionName) {
        if (activeOverlay) map.removeLayer(activeOverlay);
        if (regionName === "nz") { map.flyTo([-40.9, 174.88], 6); return; }
        
        const target = regionName.toUpperCase();
        let found = null;
        boundaryLayer.eachLayer(l => {
            if (JSON.stringify(l.feature.properties).toUpperCase().includes(target)) found = l.feature;
        });

        if (found) {
            activeOverlay = L.layerGroup().addTo(map);
            const world = [[-90, -360], [-90, 360], [90, 360], [90, -360]];
            const coords = found.geometry.type === "MultiPolygon" 
                ? found.geometry.coordinates.map(p => p[0].map(pt => [pt[1], pt[0]]))
                : found.geometry.coordinates.map(r => r.map(pt => [pt[1], pt[0]]));
            
            L.polygon([world, ...coords], { className: 'region-mask' }).addTo(activeOverlay);
            L.geoJSON(found, { className: 'region-highlight', style: { color: '#00f2ff', weight: 3, fillOpacity: 0 } }).addTo(activeOverlay);
            map.flyToBounds(L.geoJSON(found).getBounds(), { padding: [50, 50] });
        }
    }

    function searchSpots(query) {
        const q = query.toLowerCase();
        allMarkers.forEach(s => s.marker.setOpacity(s.name.toLowerCase().includes(q) ? 1 : 0.1));
    }

    function closePanel() { document.getElementById('info-panel').classList.remove('active'); }
    function locateUser() { map.locate({setView: true, maxZoom: 12}); }

    async function init() {
        await Promise.all([loadGeoData(), loadSpots()]);
        document.getElementById('loader').style.opacity = '0';
        setTimeout(() => document.getElementById('loader').style.visibility = 'hidden', 800);
    }
    init();
    </script>
</body>
</html>
